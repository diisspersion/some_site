stages:
  - lint
  - security
  - build

variables:
  # Prevent Python from writing .pyc files and enable real-time logging
  PYTHONDONTWRITEBYTECODE: "1"
  PYTHONUNBUFFERED: "1"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

  # Docker configuration
  DOCKERFILE_PATH: "./build/Dockerfile"
  IMAGE_TAG: "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA"
  LATEST_TAG: "$CI_REGISTRY_IMAGE:latest"

cache:
  paths:
    - .cache/pip

# Base template for Python jobs to reduce code duplication
.python_base:
  image: python:3.10-slim
  before_script:
    - pip install --upgrade pip
    - pip install -r ./app/requirements.txt

# Perform static code analysis
lint:
  extends: .python_base
  stage: lint
  script:
    - pip install flake8
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

security_scan:
  extends: .python_base
  stage: security
  script:
    - pip install bandit pip-audit
    - bandit -r . -f custom   # Check for security vulnerabilities in code (e.g., hardcoded credentials)
    - pip-audit               # Scan dependencies for known security flaws

build_image:
  stage: build
  image: docker:latest
  services:
    - docker:dind       # Enable Docker-in-Docker to build images inside the runner
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    # Build the image using the short commit SHA as a unique tag
    - docker build -f "$DOCKERFILE_PATH" -t "$IMAGE_TAG" -t "$LATEST_TAG" .
    - docker push $IMAGE_TAG
    - docker push $LATEST_TAG
  rules:
    - if: $CI_COMMIT_BRANCH == "main"